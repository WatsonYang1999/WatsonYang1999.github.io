<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Continuous Batching与请求调度优化分析概述Continuous Batching（连续批处理）是现代LLM推理框架的核心技术，允许动态地将新到达的请求加入正在执行的批次中，而不需要等待当前批次完成。本文深入分析TensorRT-LLM、vLLM和SGLang三个框架的Continuous Batching实现和请求调度优化策略。 目录 Continuous Batching核心原">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/07/16/System/Continuous_Batching%E4%B8%8E%E8%AF%B7%E6%B1%82%E8%B0%83%E5%BA%A6%E4%BC%98%E5%8C%96%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Continuous Batching与请求调度优化分析概述Continuous Batching（连续批处理）是现代LLM推理框架的核心技术，允许动态地将新到达的请求加入正在执行的批次中，而不需要等待当前批次完成。本文深入分析TensorRT-LLM、vLLM和SGLang三个框架的Continuous Batching实现和请求调度优化策略。 目录 Continuous Batching核心原">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-07-16T02:11:51.902Z">
<meta property="article:modified_time" content="2025-07-16T09:34:06.085Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

  
  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      securityLevel: 'loose',
      themeVariables: {
        primaryColor: '#0f4c75',
        primaryTextColor: '#fff',
        primaryBorderColor: '#0f4c75',
        lineColor: '#0f4c75',
        secondaryColor: '#006ba6',
        tertiaryColor: '#fff'
      }
    });
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-System/Continuous_Batching与请求调度优化分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/07/16/System/Continuous_Batching%E4%B8%8E%E8%AF%B7%E6%B1%82%E8%B0%83%E5%BA%A6%E4%BC%98%E5%8C%96%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2025-07-16T02:11:51.902Z" itemprop="datePublished">2025-07-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Continuous-Batching与请求调度优化分析"><a href="#Continuous-Batching与请求调度优化分析" class="headerlink" title="Continuous Batching与请求调度优化分析"></a>Continuous Batching与请求调度优化分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Continuous Batching（连续批处理）是现代LLM推理框架的核心技术，允许动态地将新到达的请求加入正在执行的批次中，而不需要等待当前批次完成。本文深入分析TensorRT-LLM、vLLM和SGLang三个框架的Continuous Batching实现和请求调度优化策略。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#continuous-batching%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86">Continuous Batching核心原理</a></li>
<li><a href="#tensorrt-llm%E8%B0%83%E5%BA%A6%E6%9E%B6%E6%9E%84">TensorRT-LLM调度架构</a></li>
<li><a href="#vllm%E8%B0%83%E5%BA%A6%E6%9E%B6%E6%9E%84">vLLM调度架构</a></li>
<li><a href="#sglang%E8%B0%83%E5%BA%A6%E6%9E%B6%E6%9E%84">SGLang调度架构</a></li>
<li><a href="#%E8%B0%83%E5%BA%A6%E5%BC%80%E9%94%80%E4%BC%98%E5%8C%96%E5%AF%B9%E6%AF%94">调度开销优化对比</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E7%AD%96%E7%95%A5">性能调优策略</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E5%BB%BA%E8%AE%AE">实现建议</a></li>
</ol>
<h2 id="Continuous-Batching核心原理"><a href="#Continuous-Batching核心原理" class="headerlink" title="Continuous Batching核心原理"></a>Continuous Batching核心原理</h2><h3 id="传统批处理-vs-连续批处理"><a href="#传统批处理-vs-连续批处理" class="headerlink" title="传统批处理 vs 连续批处理"></a>传统批处理 vs 连续批处理</h3><p><strong>传统批处理（Static Batching）</strong>:</p>
<ul>
<li>批次固定，所有请求同时开始和结束</li>
<li>需要填充（padding）到最大长度</li>
<li>资源利用率低，延迟高</li>
</ul>
<p><strong>连续批处理（Continuous Batching）</strong>:</p>
<ul>
<li>动态批次，请求可以异步加入和离开</li>
<li>无需padding，内存利用率高</li>
<li>支持不同长度的序列共存</li>
</ul>
<h3 id="关键技术挑战"><a href="#关键技术挑战" class="headerlink" title="关键技术挑战"></a>关键技术挑战</h3><ol>
<li><strong>调度开销</strong>: 频繁的请求调度带来的CPU开销</li>
<li><strong>内存管理</strong>: 动态的内存分配和释放</li>
<li><strong>负载均衡</strong>: 不同长度请求的混合调度</li>
<li><strong>资源争抢</strong>: GPU计算资源的高效利用</li>
</ol>
<h2 id="TensorRT-LLM调度架构"><a href="#TensorRT-LLM调度架构" class="headerlink" title="TensorRT-LLM调度架构"></a>TensorRT-LLM调度架构</h2><h3 id="核心设计理念"><a href="#核心设计理念" class="headerlink" title="核心设计理念"></a>核心设计理念</h3><p>TensorRT-LLM采用<strong>分层调度架构</strong>，将调度过程分解为多个层次：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调度层次结构</span></span><br><span class="line">CapacityScheduler     <span class="comment">// 容量调度器 - 确定可调度的请求</span></span><br><span class="line">    ↓</span><br><span class="line">MicroBatchScheduler   <span class="comment">// 微批调度器 - 组织微批次</span></span><br><span class="line">    ↓</span><br><span class="line">AssignReqSeqSlots     <span class="comment">// 序列槽分配器 - 分配执行槽位</span></span><br><span class="line">    ↓</span><br><span class="line">AllocateKvCache       <span class="comment">// KV缓存分配器 - 分配内存资源</span></span><br></pre></td></tr></table></figure>

<h3 id="关键组件实现"><a href="#关键组件实现" class="headerlink" title="关键组件实现"></a>关键组件实现</h3><h4 id="1-容量调度器（CapacityScheduler）"><a href="#1-容量调度器（CapacityScheduler）" class="headerlink" title="1. 容量调度器（CapacityScheduler）"></a>1. <strong>容量调度器（CapacityScheduler）</strong></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CapacityScheduler</span> &#123;</span><br><span class="line">    <span class="comment">// 多种调度策略</span></span><br><span class="line">    std::variant&lt;</span><br><span class="line">        MaxRequestsScheduler,     // 最大请求数策略</span><br><span class="line">        MaxUtilizationScheduler,  // 最大利用率策略</span><br><span class="line">        GuaranteedNoEvictScheduler, // 保证不驱逐策略</span><br><span class="line">        StaticBatchScheduler      // 静态批次策略</span><br><span class="line">    &gt; mScheduler;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::tuple&lt;RequestVector, RequestVector, RequestVector&gt; <span class="title">operator</span><span class="params">()</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        RequestList <span class="type">const</span>&amp; activeRequests,</span></span></span><br><span class="line"><span class="params"><span class="function">        OptionalRef&lt;kv_cache_manager::BaseKVCacheManager&gt; kvCacheManager,</span></span></span><br><span class="line"><span class="params"><span class="function">        OptionalRef&lt;BasePeftCacheManager <span class="type">const</span>&gt; peftCacheManager,</span></span></span><br><span class="line"><span class="params"><span class="function">        OptionalRef&lt;kv_cache_manager::BaseKVCacheManager <span class="type">const</span>&gt; crossKvCacheManager</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-微批调度器（MicroBatchScheduler）"><a href="#2-微批调度器（MicroBatchScheduler）" class="headerlink" title="2. 微批调度器（MicroBatchScheduler）"></a>2. <strong>微批调度器（MicroBatchScheduler）</strong></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MicroBatchScheduler</span> &#123;</span><br><span class="line">    <span class="function">std::tuple&lt;RequestVector, RequestVector&gt; <span class="title">operator</span><span class="params">()</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        RequestVector&amp; activeRequests,</span></span></span><br><span class="line"><span class="params"><span class="function">        ReqIdsSet <span class="type">const</span>&amp; inflightReqIds,</span></span></span><br><span class="line"><span class="params"><span class="function">        SizeType32 maxBatchSizeRuntime,</span></span></span><br><span class="line"><span class="params"><span class="function">        std::optional&lt;SizeType32&gt; maxNumTokensRuntime</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 上下文分块配置</span></span><br><span class="line">    std::optional&lt;ContextChunkingConfig&gt; mCtxChunkConfig;</span><br><span class="line">    LlmRequestState_t mNoScheduleUntilState;</span><br><span class="line">    LlmRequestState_t mNoScheduleAfterState;</span><br><span class="line">    std::optional&lt;SizeType32&gt; mMaxContextLength;</span><br><span class="line">    <span class="type">bool</span> mCtxGenFusion;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="3-请求状态管理"><a href="#3-请求状态管理" class="headerlink" title="3. 请求状态管理"></a>3. <strong>请求状态管理</strong></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">LlmRequestState</span> : <span class="type">int32_t</span> &#123;</span><br><span class="line">    kUNKNOWN = <span class="number">0</span>,</span><br><span class="line">    kENCODER_INIT = <span class="number">1</span>,</span><br><span class="line">    kDISAGG_GENERATION_INIT = <span class="number">8</span>,</span><br><span class="line">    kDISAGG_GENERATION_TRANS_IN_PROGRESS = <span class="number">9</span>,</span><br><span class="line">    kCONTEXT_INIT = <span class="number">10</span>,</span><br><span class="line">    kDISAGG_CONTEXT_INIT_AND_TRANS = <span class="number">11</span>,</span><br><span class="line">    kDISAGG_GENERATION_TRANS_COMPLETE = <span class="number">12</span>,</span><br><span class="line">    kGENERATION_IN_PROGRESS = <span class="number">13</span>,</span><br><span class="line">    kGENERATION_TO_COMPLETE = <span class="number">14</span>,</span><br><span class="line">    kGENERATION_COMPLETE = <span class="number">20</span>,</span><br><span class="line">    kDISAGG_CONTEXT_TRANS_IN_PROGRESS = <span class="number">21</span>,</span><br><span class="line">    kDISAGG_CONTEXT_COMPLETE = <span class="number">22</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="调度流程"><a href="#调度流程" class="headerlink" title="调度流程"></a>调度流程</h3><ol>
<li><p><strong>请求分类</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将请求分为不同类型</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; req : activeRequests) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req-&gt;<span class="built_in">isGenerationInProgressState</span>()) &#123;</span><br><span class="line">        scheduledRequests.<span class="built_in">emplace_back</span>(req);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;<span class="built_in">isDisaggGenerationInitState</span>()) &#123;</span><br><span class="line">        pendingDisGenInitRequests.<span class="built_in">emplace_back</span>(req);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pendingRequests.<span class="built_in">emplace_back</span>(req);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>资源检查</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查KV Cache和PEFT缓存资源</span></span><br><span class="line"><span class="type">bool</span> enoughBlocks = reservedBlocks.<span class="built_in">enoughAvailableBlocks</span>(*req);</span><br><span class="line"><span class="type">bool</span> enoughCrossBlocks = reservedCrossBlocks ? </span><br><span class="line">    reservedCrossBlocks-&gt;<span class="built_in">enoughAvailableBlocks</span>(*req) : <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">auto</span> neededPeftPages = isNewTask &amp;&amp; peftCacheManager ? </span><br><span class="line">    peftCacheManager-&gt;<span class="built_in">determineNumPages</span>(req) : <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>调度决策</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (enoughBlocks &amp;&amp; enoughCrossBlocks &amp;&amp; neededPeftPages &lt;= availablePeftPages) &#123;</span><br><span class="line">    scheduledRequests.<span class="built_in">emplace_back</span>(req);</span><br><span class="line">    <span class="comment">// 更新资源状态</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!enoughBlocks || !enoughCrossBlocks) &#123;</span><br><span class="line">    <span class="keyword">break</span>; <span class="comment">// 资源不足，停止调度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h3><h4 id="1-调度开销优化"><a href="#1-调度开销优化" class="headerlink" title="1. 调度开销优化"></a>1. <strong>调度开销优化</strong></h4><ul>
<li><strong>批次重用</strong>: 避免频繁创建和销毁批次对象</li>
<li><strong>状态缓存</strong>: 缓存调度状态以减少计算开销</li>
<li><strong>预分配</strong>: 预分配内存池减少动态分配</li>
</ul>
<h4 id="2-内存优化"><a href="#2-内存优化" class="headerlink" title="2. 内存优化"></a>2. <strong>内存优化</strong></h4><ul>
<li><strong>分层内存管理</strong>: Primary&#x2F;Secondary双层内存设计</li>
<li><strong>延迟分配</strong>: 按需分配KV Cache内存</li>
<li><strong>智能驱逐</strong>: 基于优先级的LRU驱逐策略</li>
</ul>
<h2 id="vLLM调度架构"><a href="#vLLM调度架构" class="headerlink" title="vLLM调度架构"></a>vLLM调度架构</h2><h3 id="核心设计理念-1"><a href="#核心设计理念-1" class="headerlink" title="核心设计理念"></a>核心设计理念</h3><p>vLLM采用<strong>统一调度器架构</strong>，通过单一调度器处理所有类型的请求：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.waiting = deque()     <span class="comment"># 等待队列</span></span><br><span class="line">        <span class="variable language_">self</span>.running = deque()     <span class="comment"># 运行队列</span></span><br><span class="line">        <span class="variable language_">self</span>.swapped = deque()     <span class="comment"># 交换队列</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule</span>(<span class="params">self</span>) -&gt; SchedulerOutputs:</span><br><span class="line">        <span class="comment"># 统一调度逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="关键组件实现-1"><a href="#关键组件实现-1" class="headerlink" title="关键组件实现"></a>关键组件实现</h3><h4 id="1-调度预算管理"><a href="#1-调度预算管理" class="headerlink" title="1. 调度预算管理"></a>1. <strong>调度预算管理</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchedulingBudget</span>:</span><br><span class="line">    token_budget: <span class="built_in">int</span>                                    <span class="comment"># Token预算</span></span><br><span class="line">    max_num_seqs: <span class="built_in">int</span>                                   <span class="comment"># 最大序列数</span></span><br><span class="line">    _request_ids_num_batched_tokens: <span class="type">Set</span>[<span class="built_in">str</span>]          <span class="comment"># 已批处理的请求ID</span></span><br><span class="line">    _request_ids_num_curr_seqs: <span class="type">Set</span>[<span class="built_in">str</span>]               <span class="comment"># 当前序列的请求ID</span></span><br><span class="line">    _num_cached_tokens: <span class="built_in">int</span> = <span class="number">0</span>                        <span class="comment"># 缓存Token数量</span></span><br><span class="line">    _num_batched_tokens: <span class="built_in">int</span> = <span class="number">0</span>                       <span class="comment"># 批处理Token数量</span></span><br><span class="line">    _num_curr_seqs: <span class="built_in">int</span> = <span class="number">0</span>                           <span class="comment"># 当前序列数量</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">can_schedule</span>(<span class="params">self, *, num_new_tokens: <span class="built_in">int</span>, num_new_seqs: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>.num_batched_tokens + num_new_tokens &lt;= <span class="variable language_">self</span>.token_budget</span><br><span class="line">                <span class="keyword">and</span> <span class="variable language_">self</span>.num_curr_seqs + num_new_seqs &lt;= <span class="variable language_">self</span>.max_num_seqs)</span><br></pre></td></tr></table></figure>

<h4 id="2-双模式调度策略"><a href="#2-双模式调度策略" class="headerlink" title="2. 双模式调度策略"></a>2. <strong>双模式调度策略</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">schedule</span>(<span class="params">self</span>) -&gt; SchedulerOutputs:</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.scheduler_config.chunked_prefill_enabled:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._schedule_chunked_prefill()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>._schedule_default()</span><br></pre></td></tr></table></figure>

<h4 id="3-分块预填充调度"><a href="#3-分块预填充调度" class="headerlink" title="3. 分块预填充调度"></a>3. <strong>分块预填充调度</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_schedule_chunked_prefill</span>(<span class="params">self</span>) -&gt; SchedulerOutputs:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    分块预填充调度策略：</span></span><br><span class="line"><span class="string">    1. 优先调度解码请求</span></span><br><span class="line"><span class="string">    2. 调度分块预填充请求</span></span><br><span class="line"><span class="string">    3. 调度交换请求</span></span><br><span class="line"><span class="string">    4. 调度新的预填充请求</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 解码请求优先</span></span><br><span class="line">    running_scheduled = <span class="variable language_">self</span>._schedule_running(</span><br><span class="line">        budget, curr_loras, enable_chunking=<span class="literal">True</span>, </span><br><span class="line">        partial_prefill_metadata=partial_prefill_metadata</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 交换请求</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(running_scheduled.preempted) + <span class="built_in">len</span>(running_scheduled.swapped_out) == <span class="number">0</span>:</span><br><span class="line">        swapped_in = <span class="variable language_">self</span>._schedule_swapped(budget, curr_loras)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 预填充请求</span></span><br><span class="line">    prefills = <span class="variable language_">self</span>._schedule_prefills(</span><br><span class="line">        budget, curr_loras, enable_chunking=<span class="literal">True</span>,</span><br><span class="line">        partial_prefill_metadata=partial_prefill_metadata</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h3 id="vLLM-V1架构优化"><a href="#vLLM-V1架构优化" class="headerlink" title="vLLM V1架构优化"></a>vLLM V1架构优化</h3><h4 id="1-统一Token调度"><a href="#1-统一Token调度" class="headerlink" title="1. 统一Token调度"></a>1. <strong>统一Token调度</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span>(<span class="title class_ inherited__">SchedulerInterface</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule</span>(<span class="params">self</span>) -&gt; SchedulerOutput:</span><br><span class="line">        <span class="comment"># 统一的Token调度逻辑</span></span><br><span class="line">        <span class="comment"># 没有传统的&quot;解码阶段&quot;和&quot;预填充阶段&quot;区分</span></span><br><span class="line">        <span class="comment"># 每个请求都有num_computed_tokens和num_tokens_with_spec</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 调度运行中的请求</span></span><br><span class="line">        <span class="keyword">for</span> request <span class="keyword">in</span> <span class="variable language_">self</span>.running:</span><br><span class="line">            num_new_tokens = (request.num_tokens_with_spec - </span><br><span class="line">                            request.num_computed_tokens)</span><br><span class="line">            <span class="comment"># 分配KV Cache槽位</span></span><br><span class="line">            new_blocks = <span class="variable language_">self</span>.kv_cache_manager.allocate_slots(</span><br><span class="line">                request, num_new_tokens, </span><br><span class="line">                num_lookahead_tokens=<span class="variable language_">self</span>.num_lookahead_tokens</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h4 id="2-抢占式调度"><a href="#2-抢占式调度" class="headerlink" title="2. 抢占式调度"></a>2. <strong>抢占式调度</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">schedule</span>(<span class="params">self</span>) -&gt; SchedulerOutput:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        new_blocks = <span class="variable language_">self</span>.kv_cache_manager.allocate_slots(...)</span><br><span class="line">        <span class="keyword">if</span> new_blocks <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 内存不足，抢占最低优先级请求</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.policy == SchedulingPolicy.PRIORITY:</span><br><span class="line">                preempted_req = <span class="built_in">max</span>(</span><br><span class="line">                    <span class="variable language_">self</span>.running,</span><br><span class="line">                    key=<span class="keyword">lambda</span> r: (r.priority, r.arrival_time),</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                preempted_req = <span class="variable language_">self</span>.running.pop()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 释放资源并重新调度</span></span><br><span class="line">            <span class="variable language_">self</span>.kv_cache_manager.free(preempted_req)</span><br><span class="line">            preempted_req.status = RequestStatus.PREEMPTED</span><br></pre></td></tr></table></figure>

<h3 id="优化策略-1"><a href="#优化策略-1" class="headerlink" title="优化策略"></a>优化策略</h3><h4 id="1-批次队列优化"><a href="#1-批次队列优化" class="headerlink" title="1. 批次队列优化"></a>1. <strong>批次队列优化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">step_with_batch_queue</span>(<span class="params">self</span>) -&gt; <span class="built_in">tuple</span>[<span class="type">Optional</span>[<span class="built_in">dict</span>[<span class="built_in">int</span>, EngineCoreOutputs]], <span class="built_in">bool</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    使用批次队列优化调度：</span></span><br><span class="line"><span class="string">    1. 非阻塞调度新批次</span></span><br><span class="line"><span class="string">    2. 异步执行模型推理</span></span><br><span class="line"><span class="string">    3. 流水线化处理</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.batch_queue.full():</span><br><span class="line">        scheduler_output = <span class="variable language_">self</span>.scheduler.schedule()</span><br><span class="line">        <span class="keyword">if</span> scheduler_output.total_num_scheduled_tokens &gt; <span class="number">0</span>:</span><br><span class="line">            future = <span class="variable language_">self</span>.model_executor.execute_model(scheduler_output)</span><br><span class="line">            <span class="variable language_">self</span>.batch_queue.put_nowait((future, scheduler_output))</span><br></pre></td></tr></table></figure>

<h4 id="2-预填充分块优化"><a href="#2-预填充分块优化" class="headerlink" title="2. 预填充分块优化"></a>2. <strong>预填充分块优化</strong></h4><ul>
<li><strong>动态分块</strong>: 根据可用资源动态调整分块大小</li>
<li><strong>优先级调度</strong>: 解码请求优先，保证低延迟</li>
<li><strong>资源预留</strong>: 为运行请求预留资源，避免饥饿</li>
</ul>
<h2 id="SGLang调度架构"><a href="#SGLang调度架构" class="headerlink" title="SGLang调度架构"></a>SGLang调度架构</h2><h3 id="核心设计理念-2"><a href="#核心设计理念-2" class="headerlink" title="核心设计理念"></a>核心设计理念</h3><p>SGLang采用<strong>事件驱动调度架构</strong>，支持多种运行模式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.waiting_queue = []           <span class="comment"># 等待队列</span></span><br><span class="line">        <span class="variable language_">self</span>.running_batch = ScheduleBatch()  <span class="comment"># 运行批次</span></span><br><span class="line">        <span class="variable language_">self</span>.cur_batch = <span class="literal">None</span>            <span class="comment"># 当前批次</span></span><br><span class="line">        <span class="variable language_">self</span>.last_batch = <span class="literal">None</span>           <span class="comment"># 上次批次</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">event_loop_normal</span>(<span class="params">self</span>):         <span class="comment"># 标准事件循环</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">event_loop_overlap</span>(<span class="params">self</span>):        <span class="comment"># 重叠事件循环</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">event_loop_pp</span>(<span class="params">self</span>):             <span class="comment"># 流水线并行事件循环</span></span><br></pre></td></tr></table></figure>

<h3 id="关键组件实现-2"><a href="#关键组件实现-2" class="headerlink" title="关键组件实现"></a>关键组件实现</h3><h4 id="1-多模式事件循环"><a href="#1-多模式事件循环" class="headerlink" title="1. 多模式事件循环"></a>1. <strong>多模式事件循环</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DynamicGradMode()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">event_loop_normal</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;标准调度循环&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        recv_reqs = <span class="variable language_">self</span>.recv_requests()</span><br><span class="line">        <span class="variable language_">self</span>.process_input_requests(recv_reqs)</span><br><span class="line">        </span><br><span class="line">        batch = <span class="variable language_">self</span>.get_next_batch_to_run()</span><br><span class="line">        <span class="variable language_">self</span>.cur_batch = batch</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> batch:</span><br><span class="line">            result = <span class="variable language_">self</span>.run_batch(batch)</span><br><span class="line">            <span class="variable language_">self</span>.process_batch_result(batch, result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.check_memory()</span><br><span class="line">            <span class="variable language_">self</span>.new_token_ratio = <span class="variable language_">self</span>.init_new_token_ratio</span><br><span class="line"></span><br><span class="line"><span class="meta">@DynamicGradMode()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">event_loop_overlap</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;重叠调度循环 - CPU处理与GPU计算重叠&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 异步处理上次批次结果</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.last_batch:</span><br><span class="line">            tmp_batch, tmp_result = <span class="variable language_">self</span>.result_queue.popleft()</span><br><span class="line">            <span class="variable language_">self</span>.process_batch_result(tmp_batch, tmp_result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 同时准备新批次</span></span><br><span class="line">        batch = <span class="variable language_">self</span>.get_next_batch_to_run()</span><br><span class="line">        <span class="keyword">if</span> batch:</span><br><span class="line">            result = <span class="variable language_">self</span>.run_batch(batch)</span><br><span class="line">            <span class="variable language_">self</span>.result_queue.append((batch.copy(), result))</span><br></pre></td></tr></table></figure>

<h4 id="2-智能预填充调度"><a href="#2-智能预填充调度" class="headerlink" title="2. 智能预填充调度"></a>2. <strong>智能预填充调度</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrefillAdder</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_size, tree_cache, token_to_kv_pool_allocator, </span></span><br><span class="line"><span class="params">                 running_batch, new_token_ratio, max_prefill_tokens,</span></span><br><span class="line"><span class="params">                 chunked_prefill_size, mixed_chunk_size</span>):</span><br><span class="line">        <span class="variable language_">self</span>.can_run_list = []</span><br><span class="line">        <span class="variable language_">self</span>.new_chunked_req = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_one_req</span>(<span class="params">self, req: Req, has_chunked_req: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; AddReqResult:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加单个请求到预填充批次&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查Token预算</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.total_token_num + req.extend_input_len &gt; <span class="variable language_">self</span>.max_prefill_tokens:</span><br><span class="line">            <span class="keyword">return</span> AddReqResult.NO_TOKEN</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 检查KV Cache资源</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.alloc_req(req):</span><br><span class="line">            <span class="keyword">return</span> AddReqResult.NO_MEM</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 成功添加请求</span></span><br><span class="line">        <span class="variable language_">self</span>.can_run_list.append(req)</span><br><span class="line">        <span class="keyword">return</span> AddReqResult.CONTINUE</span><br></pre></td></tr></table></figure>

<h4 id="3-分块预填充优化"><a href="#3-分块预填充优化" class="headerlink" title="3. 分块预填充优化"></a>3. <strong>分块预填充优化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_new_batch_prefill</span>(<span class="params">self</span>) -&gt; <span class="type">Optional</span>[ScheduleBatch]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取新的预填充批次&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 处理分块请求</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.chunked_req <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.chunked_req.init_next_round_input()</span><br><span class="line">        <span class="variable language_">self</span>.chunked_req = adder.add_chunked_req(<span class="variable language_">self</span>.chunked_req)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理等待队列中的请求</span></span><br><span class="line">    <span class="keyword">for</span> req <span class="keyword">in</span> <span class="variable language_">self</span>.waiting_queue:</span><br><span class="line">        req.init_next_round_input(<span class="variable language_">self</span>.tree_cache)</span><br><span class="line">        res = adder.add_one_req(req, has_chunked_req=(<span class="variable language_">self</span>.chunked_req <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> res != AddReqResult.CONTINUE:</span><br><span class="line">            <span class="keyword">if</span> res == AddReqResult.NO_TOKEN:</span><br><span class="line">                <span class="variable language_">self</span>.running_batch.batch_is_full = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="高级优化策略"><a href="#高级优化策略" class="headerlink" title="高级优化策略"></a>高级优化策略</h3><h4 id="1-调度策略优化"><a href="#1-调度策略优化" class="headerlink" title="1. 调度策略优化"></a>1. <strong>调度策略优化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SchedulePolicy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, policy_name, tree_cache, enable_hierarchical_cache</span>):</span><br><span class="line">        <span class="variable language_">self</span>.policy_name = policy_name</span><br><span class="line">        <span class="variable language_">self</span>.tree_cache = tree_cache</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calc_priority</span>(<span class="params">self, waiting_queue</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算请求优先级&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.policy_name == <span class="string">&quot;lpm&quot;</span>:  <span class="comment"># Longest Prefix Match</span></span><br><span class="line">            <span class="variable language_">self</span>._calc_lpm_priority(waiting_queue)</span><br><span class="line">        <span class="keyword">elif</span> <span class="variable language_">self</span>.policy_name == <span class="string">&quot;fcfs&quot;</span>:  <span class="comment"># First Come First Serve</span></span><br><span class="line">            <span class="variable language_">self</span>._calc_fcfs_priority(waiting_queue)</span><br><span class="line">        <span class="keyword">elif</span> <span class="variable language_">self</span>.policy_name == <span class="string">&quot;dfs-weight&quot;</span>:  <span class="comment"># DFS with Weight</span></span><br><span class="line">            <span class="variable language_">self</span>._calc_dfs_weight_priority(waiting_queue)</span><br></pre></td></tr></table></figure>

<h4 id="2-内存抢占与回收"><a href="#2-内存抢占与回收" class="headerlink" title="2. 内存抢占与回收"></a>2. <strong>内存抢占与回收</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update_running_batch</span>(<span class="params">self, batch: ScheduleBatch</span>) -&gt; <span class="type">Optional</span>[ScheduleBatch]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;更新运行批次，处理内存不足情况&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 检查解码内存</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> batch.check_decode_mem(<span class="variable language_">self</span>.decode_mem_cache_buf_multiplier):</span><br><span class="line">        <span class="comment"># 内存不足，回收请求</span></span><br><span class="line">        retracted_reqs, new_token_ratio = batch.retract_decode(<span class="variable language_">self</span>.server_args)</span><br><span class="line">        <span class="variable language_">self</span>.new_token_ratio = new_token_ratio</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">f&quot;KV cache pool is full. Retract requests. &quot;</span></span><br><span class="line">                   <span class="string">f&quot;#retracted_reqs: <span class="subst">&#123;<span class="built_in">len</span>(retracted_reqs)&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将回收的请求重新加入等待队列</span></span><br><span class="line">        <span class="variable language_">self</span>._extend_requests_to_queue(retracted_reqs, is_retracted=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-批次合并优化"><a href="#3-批次合并优化" class="headerlink" title="3. 批次合并优化"></a>3. <strong>批次合并优化</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mix_with_running</span>(<span class="params">self, running_batch: <span class="string">&quot;ScheduleBatch&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;混合批次调度 - 预填充与解码混合&quot;&quot;&quot;</span></span><br><span class="line">    <span class="variable language_">self</span>.forward_mode = ForwardMode.MIXED</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 合并输入张量</span></span><br><span class="line">    input_ids = torch.cat([<span class="variable language_">self</span>.input_ids, running_batch.input_ids])</span><br><span class="line">    out_cache_loc = torch.cat([<span class="variable language_">self</span>.out_cache_loc, running_batch.out_cache_loc])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 合并批次状态</span></span><br><span class="line">    <span class="variable language_">self</span>.merge_batch(running_batch)</span><br><span class="line">    <span class="variable language_">self</span>.input_ids = input_ids</span><br><span class="line">    <span class="variable language_">self</span>.out_cache_loc = out_cache_loc</span><br></pre></td></tr></table></figure>

<h2 id="调度开销优化对比"><a href="#调度开销优化对比" class="headerlink" title="调度开销优化对比"></a>调度开销优化对比</h2><h3 id="1-调度算法复杂度"><a href="#1-调度算法复杂度" class="headerlink" title="1. 调度算法复杂度"></a>1. <strong>调度算法复杂度</strong></h3><table>
<thead>
<tr>
<th>框架</th>
<th>调度复杂度</th>
<th>优化策略</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>TensorRT-LLM</strong></td>
<td>O(n log n)</td>
<td>分层调度 + 预排序</td>
<td>企业级稳定性</td>
</tr>
<tr>
<td><strong>vLLM</strong></td>
<td>O(n)</td>
<td>统一调度 + 预算管理</td>
<td>简洁高效</td>
</tr>
<tr>
<td><strong>SGLang</strong></td>
<td>O(n)</td>
<td>事件驱动 + 智能缓存</td>
<td>功能全面</td>
</tr>
</tbody></table>
<h3 id="2-内存分配开销"><a href="#2-内存分配开销" class="headerlink" title="2. 内存分配开销"></a>2. <strong>内存分配开销</strong></h3><table>
<thead>
<tr>
<th>操作</th>
<th>TensorRT-LLM</th>
<th>vLLM</th>
<th>SGLang</th>
</tr>
</thead>
<tbody><tr>
<td><strong>KV Cache分配</strong></td>
<td>预分配池 + 引用计数</td>
<td>Block分配器</td>
<td>三层内存池</td>
</tr>
<tr>
<td><strong>内存回收</strong></td>
<td>延迟回收 + LRU</td>
<td>即时回收</td>
<td>批量回收</td>
</tr>
<tr>
<td><strong>内存碎片</strong></td>
<td>低（固定块大小）</td>
<td>中（动态分配）</td>
<td>低（页对齐）</td>
</tr>
</tbody></table>
<h3 id="3-调度延迟优化"><a href="#3-调度延迟优化" class="headerlink" title="3. 调度延迟优化"></a>3. <strong>调度延迟优化</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TensorRT-LLM: 分层调度减少计算开销</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CapacityScheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, activeRequests</span>):</span><br><span class="line">        <span class="comment"># 1. 快速过滤不可调度请求</span></span><br><span class="line">        <span class="comment"># 2. 分层资源检查</span></span><br><span class="line">        <span class="comment"># 3. 批量分配资源</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vLLM: 预算管理避免重复计算</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchedulingBudget</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">can_schedule</span>(<span class="params">self, num_new_tokens, num_new_seqs</span>):</span><br><span class="line">        <span class="comment"># O(1)复杂度的资源检查</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="variable language_">self</span>.num_batched_tokens + num_new_tokens &lt;= <span class="variable language_">self</span>.token_budget</span><br><span class="line">                <span class="keyword">and</span> <span class="variable language_">self</span>.num_curr_seqs + num_new_seqs &lt;= <span class="variable language_">self</span>.max_num_seqs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SGLang: 事件驱动减少轮询开销</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">event_loop_overlap</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># CPU处理与GPU计算重叠</span></span><br><span class="line">    <span class="comment"># 异步结果处理</span></span><br><span class="line">    <span class="comment"># 批次重用优化</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h2 id="性能调优策略"><a href="#性能调优策略" class="headerlink" title="性能调优策略"></a>性能调优策略</h2><h3 id="1-TensorRT-LLM调优"><a href="#1-TensorRT-LLM调优" class="headerlink" title="1. TensorRT-LLM调优"></a>1. <strong>TensorRT-LLM调优</strong></h3><h4 id="关键参数"><a href="#关键参数" class="headerlink" title="关键参数"></a>关键参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调度策略选择</span></span><br><span class="line">--capacity-scheduler-policy=MAX_UTILIZATION  <span class="comment"># 最大利用率</span></span><br><span class="line">--capacity-scheduler-policy=GUARANTEED_NO_EVICT  <span class="comment"># 保证不驱逐</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批次大小调优</span></span><br><span class="line">--max-batch-size=128</span><br><span class="line">--max-num-tokens=4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存管理</span></span><br><span class="line">--kv-cache-percent=0.9</span><br><span class="line">--enable-kv-cache-reuse=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监控调度开销</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SchedulingMetrics</span> &#123;</span><br><span class="line">    <span class="type">double</span> scheduling_time_ms;</span><br><span class="line">    <span class="type">size_t</span> scheduled_requests;</span><br><span class="line">    <span class="type">size_t</span> preempted_requests;</span><br><span class="line">    <span class="type">double</span> kv_cache_hit_rate;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-vLLM调优"><a href="#2-vLLM调优" class="headerlink" title="2. vLLM调优"></a>2. <strong>vLLM调优</strong></h3><h4 id="关键参数-1"><a href="#关键参数-1" class="headerlink" title="关键参数"></a>关键参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用分块预填充</span></span><br><span class="line">--enable-chunked-prefill</span><br><span class="line">--<span class="built_in">max</span>-num-batched-tokens=<span class="number">2048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存配置</span></span><br><span class="line">--gpu-memory-utilization=<span class="number">0.9</span></span><br><span class="line">--swap-space=<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调度策略</span></span><br><span class="line">--scheduler-policy=priority</span><br><span class="line">--preemption-mode=recompute</span><br></pre></td></tr></table></figure>

<h4 id="性能监控-1"><a href="#性能监控-1" class="headerlink" title="性能监控"></a>性能监控</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控调度性能</span></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SchedulingMetrics</span>:</span><br><span class="line">    scheduling_time: <span class="built_in">float</span></span><br><span class="line">    num_preempted: <span class="built_in">int</span></span><br><span class="line">    cache_hit_rate: <span class="built_in">float</span></span><br><span class="line">    memory_utilization: <span class="built_in">float</span></span><br></pre></td></tr></table></figure>

<h3 id="3-SGLang调优"><a href="#3-SGLang调优" class="headerlink" title="3. SGLang调优"></a>3. <strong>SGLang调优</strong></h3><h4 id="关键参数-2"><a href="#关键参数-2" class="headerlink" title="关键参数"></a>关键参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调度策略</span></span><br><span class="line">--schedule-policy=lpm  <span class="comment"># 最长前缀匹配</span></span><br><span class="line">--schedule-conservativeness=1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分块预填充</span></span><br><span class="line">--chunked-prefill-size=4096</span><br><span class="line">--enable-mixed-chunk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存配置</span></span><br><span class="line">--mem-fraction-static=0.9</span><br><span class="line">--max-prefill-tokens=16384</span><br></pre></td></tr></table></figure>

<h4 id="性能监控-2"><a href="#性能监控-2" class="headerlink" title="性能监控"></a>性能监控</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实时性能监控</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_prefill_stats</span>(<span class="params">self, adder, can_run_list, running_bs</span>):</span><br><span class="line">        logger.info(<span class="string">f&quot;Prefill batch. &quot;</span></span><br><span class="line">                   <span class="string">f&quot;#new-req: <span class="subst">&#123;<span class="built_in">len</span>(can_run_list)&#125;</span>, &quot;</span></span><br><span class="line">                   <span class="string">f&quot;#new-token: <span class="subst">&#123;adder.total_token_num&#125;</span>, &quot;</span></span><br><span class="line">                   <span class="string">f&quot;#running-req: <span class="subst">&#123;running_bs&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="实现建议"><a href="#实现建议" class="headerlink" title="实现建议"></a>实现建议</h2><h3 id="1-选择合适的调度策略"><a href="#1-选择合适的调度策略" class="headerlink" title="1. 选择合适的调度策略"></a>1. <strong>选择合适的调度策略</strong></h3><h4 id="简单场景（单一模型、稳定负载）"><a href="#简单场景（单一模型、稳定负载）" class="headerlink" title="简单场景（单一模型、稳定负载）"></a>简单场景（单一模型、稳定负载）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推荐：vLLM的简洁设计</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleScheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_batch_size, max_tokens</span>):</span><br><span class="line">        <span class="variable language_">self</span>.max_batch_size = max_batch_size</span><br><span class="line">        <span class="variable language_">self</span>.max_tokens = max_tokens</span><br><span class="line">        <span class="variable language_">self</span>.budget = SchedulingBudget(max_tokens, max_batch_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule</span>(<span class="params">self, waiting_requests</span>):</span><br><span class="line">        scheduled = []</span><br><span class="line">        <span class="keyword">for</span> req <span class="keyword">in</span> waiting_requests:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.budget.can_schedule(req.num_tokens, <span class="number">1</span>):</span><br><span class="line">                scheduled.append(req)</span><br><span class="line">                <span class="variable language_">self</span>.budget.add_request(req)</span><br><span class="line">        <span class="keyword">return</span> scheduled</span><br></pre></td></tr></table></figure>

<h4 id="复杂场景（多模型、动态负载）"><a href="#复杂场景（多模型、动态负载）" class="headerlink" title="复杂场景（多模型、动态负载）"></a>复杂场景（多模型、动态负载）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推荐：SGLang的事件驱动设计</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventDrivenScheduler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.event_queue = queue.Queue()</span><br><span class="line">        <span class="variable language_">self</span>.policy = SchedulePolicy(<span class="string">&quot;dfs-weight&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule_event_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            event = <span class="variable language_">self</span>.event_queue.get()</span><br><span class="line">            <span class="keyword">if</span> event.<span class="built_in">type</span> == <span class="string">&quot;new_request&quot;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.handle_new_request(event.request)</span><br><span class="line">            <span class="keyword">elif</span> event.<span class="built_in">type</span> == <span class="string">&quot;request_finished&quot;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.handle_finished_request(event.request)</span><br></pre></td></tr></table></figure>

<h4 id="企业级场景（高可靠性、SLA要求）"><a href="#企业级场景（高可靠性、SLA要求）" class="headerlink" title="企业级场景（高可靠性、SLA要求）"></a>企业级场景（高可靠性、SLA要求）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐：TensorRT-LLM的分层设计</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnterpriseScheduler</span> &#123;</span><br><span class="line">    std::unique_ptr&lt;CapacityScheduler&gt; capacity_scheduler;</span><br><span class="line">    std::unique_ptr&lt;MicroBatchScheduler&gt; micro_batch_scheduler;</span><br><span class="line">    std::unique_ptr&lt;ResourceManager&gt; resource_manager;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">SchedulingResult <span class="title">schedule</span><span class="params">(<span class="type">const</span> RequestList&amp; requests)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 容量调度</span></span><br><span class="line">        <span class="keyword">auto</span> [fitting_requests, paused_requests] = </span><br><span class="line">            capacity_scheduler-&gt;<span class="built_in">schedule</span>(requests);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 微批调度</span></span><br><span class="line">        <span class="keyword">auto</span> [context_requests, generation_requests] = </span><br><span class="line">            micro_batch_scheduler-&gt;<span class="built_in">schedule</span>(fitting_requests);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 资源分配</span></span><br><span class="line">        resource_manager-&gt;<span class="built_in">allocate_resources</span>(context_requests, generation_requests);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;context_requests, generation_requests, paused_requests&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-关键优化技巧"><a href="#2-关键优化技巧" class="headerlink" title="2. 关键优化技巧"></a>2. <strong>关键优化技巧</strong></h3><h4 id="减少调度开销"><a href="#减少调度开销" class="headerlink" title="减少调度开销"></a>减少调度开销</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 批次重用</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BatchReuser</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.batch_pool = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_batch</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.batch_pool.pop() <span class="keyword">if</span> <span class="variable language_">self</span>.batch_pool <span class="keyword">else</span> Batch()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">return_batch</span>(<span class="params">self, batch</span>):</span><br><span class="line">        batch.clear()</span><br><span class="line">        <span class="variable language_">self</span>.batch_pool.append(batch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 预计算优化</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequestPreprocessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.token_cache = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.priority_cache = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">preprocess_request</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="comment"># 缓存tokenization结果</span></span><br><span class="line">        <span class="keyword">if</span> request.text <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.token_cache:</span><br><span class="line">            <span class="variable language_">self</span>.token_cache[request.text] = <span class="variable language_">self</span>.tokenize(request.text)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 缓存优先级计算</span></span><br><span class="line">        <span class="keyword">if</span> request.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.priority_cache:</span><br><span class="line">            <span class="variable language_">self</span>.priority_cache[request.<span class="built_in">id</span>] = <span class="variable language_">self</span>.calculate_priority(request)</span><br></pre></td></tr></table></figure>

<h4 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3. 分层内存管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HierarchicalMemoryManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.l1_cache = FastMemoryPool(size=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)  <span class="comment"># 1GB GPU</span></span><br><span class="line">        <span class="variable language_">self</span>.l2_cache = MediumMemoryPool(size=<span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)  <span class="comment"># 4GB CPU</span></span><br><span class="line">        <span class="variable language_">self</span>.l3_cache = SlowMemoryPool(size=<span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)  <span class="comment"># 16GB SSD</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">allocate</span>(<span class="params">self, size</span>):</span><br><span class="line">        <span class="keyword">if</span> block := <span class="variable language_">self</span>.l1_cache.allocate(size):</span><br><span class="line">            <span class="keyword">return</span> block</span><br><span class="line">        <span class="keyword">elif</span> block := <span class="variable language_">self</span>.l2_cache.allocate(size):</span><br><span class="line">            <span class="keyword">return</span> block</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.l3_cache.allocate(size)</span><br></pre></td></tr></table></figure>

<h3 id="3-性能监控与调优"><a href="#3-性能监控与调优" class="headerlink" title="3. 性能监控与调优"></a>3. <strong>性能监控与调优</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SchedulingProfiler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.metrics = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">profile_scheduling</span>(<span class="params">self, scheduler</span>):</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 调度执行</span></span><br><span class="line">        result = scheduler.schedule()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录指标</span></span><br><span class="line">        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;scheduling_time&#x27;</span>].append(time.time() - start_time)</span><br><span class="line">        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;scheduled_requests&#x27;</span>].append(<span class="built_in">len</span>(result.scheduled))</span><br><span class="line">        <span class="variable language_">self</span>.metrics[<span class="string">&#x27;memory_utilization&#x27;</span>].append(scheduler.get_memory_utilization())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_performance_report</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;avg_scheduling_time&#x27;</span>: np.mean(<span class="variable language_">self</span>.metrics[<span class="string">&#x27;scheduling_time&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;avg_scheduled_requests&#x27;</span>: np.mean(<span class="variable language_">self</span>.metrics[<span class="string">&#x27;scheduled_requests&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;avg_memory_utilization&#x27;</span>: np.mean(<span class="variable language_">self</span>.metrics[<span class="string">&#x27;memory_utilization&#x27;</span>]),</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>三个框架在Continuous Batching和请求调度方面各有特色：</p>
<h3 id="架构特点"><a href="#架构特点" class="headerlink" title="架构特点"></a><strong>架构特点</strong></h3><ul>
<li><strong>TensorRT-LLM</strong>: 分层调度架构，企业级稳定性</li>
<li><strong>vLLM</strong>: 统一调度器，简洁高效</li>
<li><strong>SGLang</strong>: 事件驱动架构，功能全面</li>
</ul>
<h3 id="性能特点"><a href="#性能特点" class="headerlink" title="性能特点"></a><strong>性能特点</strong></h3><ul>
<li><strong>调度延迟</strong>: SGLang &lt; vLLM &lt; TensorRT-LLM</li>
<li><strong>内存效率</strong>: TensorRT-LLM &gt; SGLang &gt; vLLM</li>
<li><strong>扩展性</strong>: SGLang &gt; TensorRT-LLM &gt; vLLM</li>
</ul>
<h3 id="选择建议"><a href="#选择建议" class="headerlink" title="选择建议"></a><strong>选择建议</strong></h3><ol>
<li><strong>快速原型</strong>: vLLM（简洁易用）</li>
<li><strong>生产环境</strong>: TensorRT-LLM（稳定可靠）</li>
<li><strong>研究平台</strong>: SGLang（功能丰富）</li>
<li><strong>定制需求</strong>: 结合三者优势设计</li>
</ol>
<p>关键是根据具体场景选择合适的调度策略，并持续监控和优化性能指标。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/07/16/System/Continuous_Batching%E4%B8%8E%E8%AF%B7%E6%B1%82%E8%B0%83%E5%BA%A6%E4%BC%98%E5%8C%96%E5%88%86%E6%9E%90/" data-id="cme17ouzt000pwnon2a8s5usk" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/07/16/System/KVCache%E6%B1%A0%E5%8C%96%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/07/14/mermaid-test/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Mermaid Charts Test Page</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Test/">Test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Attention/" rel="tag">Attention</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Communication/" rel="tag">Communication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compiler/" rel="tag">Compiler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Computational-Graph/" rel="tag">Computational Graph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DeepSeek/" rel="tag">DeepSeek</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed/" rel="tag">Distributed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LLM/" rel="tag">LLM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MoE/" rel="tag">MoE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Optimization/" rel="tag">Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/" rel="tag">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SGLang/" rel="tag">SGLang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/" rel="tag">System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blues/" rel="tag">blues</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/career/" rel="tag">career</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/charts/" rel="tag">charts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/consensus/" rel="tag">consensus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/data-parallelism/" rel="tag">data-parallelism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed-systems/" rel="tag">distributed-systems</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experience/" rel="tag">experience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/expert-parallelism/" rel="tag">expert-parallelism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/guitar/" rel="tag">guitar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/harmony/" rel="tag">harmony</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/licks/" rel="tag">licks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/llm/" rel="tag">llm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mermaid/" rel="tag">mermaid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raft/" rel="tag">raft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rhythm/" rel="tag">rhythm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/Attention/" style="font-size: 10px;">Attention</a> <a href="/tags/Communication/" style="font-size: 10px;">Communication</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Computational-Graph/" style="font-size: 10px;">Computational Graph</a> <a href="/tags/DeepSeek/" style="font-size: 10px;">DeepSeek</a> <a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a> <a href="/tags/LLM/" style="font-size: 10px;">LLM</a> <a href="/tags/MoE/" style="font-size: 10px;">MoE</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/SGLang/" style="font-size: 10px;">SGLang</a> <a href="/tags/System/" style="font-size: 15px;">System</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/blues/" style="font-size: 20px;">blues</a> <a href="/tags/career/" style="font-size: 10px;">career</a> <a href="/tags/charts/" style="font-size: 10px;">charts</a> <a href="/tags/consensus/" style="font-size: 10px;">consensus</a> <a href="/tags/data-parallelism/" style="font-size: 10px;">data-parallelism</a> <a href="/tags/distributed-systems/" style="font-size: 20px;">distributed-systems</a> <a href="/tags/experience/" style="font-size: 10px;">experience</a> <a href="/tags/expert-parallelism/" style="font-size: 10px;">expert-parallelism</a> <a href="/tags/guitar/" style="font-size: 20px;">guitar</a> <a href="/tags/harmony/" style="font-size: 10px;">harmony</a> <a href="/tags/licks/" style="font-size: 10px;">licks</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/llm/" style="font-size: 15px;">llm</a> <a href="/tags/mermaid/" style="font-size: 10px;">mermaid</a> <a href="/tags/raft/" style="font-size: 10px;">raft</a> <a href="/tags/rhythm/" style="font-size: 10px;">rhythm</a> <a href="/tags/test/" style="font-size: 10px;">test</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">August 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">July 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/08/03/Plans/%E5%B7%A5%E4%BD%9C%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%9A%BE%E9%A2%98/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/08/02/System/LLM%20Serving%20Configs/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/31/System/cuda-kernel/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/31/Programming/CPP/constexpr/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/30/System/%E5%B9%B6%E8%A1%8C%E7%AD%96%E7%95%A5/%E5%BA%8F%E5%88%97%E5%B9%B6%E8%A1%8C/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






<!-- Mermaid Support -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    themeVariables: {
      primaryColor: '#0f4c75',
      primaryTextColor: '#fff',
      primaryBorderColor: '#0f4c75',
      lineColor: '#0f4c75',
      secondaryColor: '#006ba6',
      tertiaryColor: '#fff'
    }
  });
</script>
  </div>
</body>
</html>