<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="jemalloc 内存分配器详解概述jemalloc 是一个通用的内存分配器，由 Jason Evans 开发，最初为 FreeBSD 系统设计，现在被广泛应用于各种高性能系统中。它以其出色的内存碎片控制、多线程性能和可扩展性而闻名。 1. jemalloc 核心原理1.1 设计目标jemalloc 的设计目标包括：  减少内存碎片：通过精心设计的内存布局和分配策略 提高多线程性能：减少线程间的锁">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/07/10/Programming/CPP/jemalloc/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="jemalloc 内存分配器详解概述jemalloc 是一个通用的内存分配器，由 Jason Evans 开发，最初为 FreeBSD 系统设计，现在被广泛应用于各种高性能系统中。它以其出色的内存碎片控制、多线程性能和可扩展性而闻名。 1. jemalloc 核心原理1.1 设计目标jemalloc 的设计目标包括：  减少内存碎片：通过精心设计的内存布局和分配策略 提高多线程性能：减少线程间的锁">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-07-10T01:24:11.149Z">
<meta property="article:modified_time" content="2025-07-10T01:32:04.690Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

  
  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      securityLevel: 'loose',
      themeVariables: {
        primaryColor: '#0f4c75',
        primaryTextColor: '#fff',
        primaryBorderColor: '#0f4c75',
        lineColor: '#0f4c75',
        secondaryColor: '#006ba6',
        tertiaryColor: '#fff'
      }
    });
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Programming/CPP/jemalloc" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/07/10/Programming/CPP/jemalloc/" class="article-date">
  <time class="dt-published" datetime="2025-07-10T01:24:11.149Z" itemprop="datePublished">2025-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="jemalloc-内存分配器详解"><a href="#jemalloc-内存分配器详解" class="headerlink" title="jemalloc 内存分配器详解"></a>jemalloc 内存分配器详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>jemalloc 是一个通用的内存分配器，由 Jason Evans 开发，最初为 FreeBSD 系统设计，现在被广泛应用于各种高性能系统中。它以其出色的内存碎片控制、多线程性能和可扩展性而闻名。</p>
<h2 id="1-jemalloc-核心原理"><a href="#1-jemalloc-核心原理" class="headerlink" title="1. jemalloc 核心原理"></a>1. jemalloc 核心原理</h2><h3 id="1-1-设计目标"><a href="#1-1-设计目标" class="headerlink" title="1.1 设计目标"></a>1.1 设计目标</h3><p>jemalloc 的设计目标包括：</p>
<ul>
<li><strong>减少内存碎片</strong>：通过精心设计的内存布局和分配策略</li>
<li><strong>提高多线程性能</strong>：减少线程间的锁竞争</li>
<li><strong>可扩展性</strong>：支持大内存分配和多种分配模式</li>
<li><strong>可观测性</strong>：提供详细的内存使用统计信息</li>
</ul>
<h3 id="1-2-内存布局架构"><a href="#1-2-内存布局架构" class="headerlink" title="1.2 内存布局架构"></a>1.2 内存布局架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">jemalloc 内存布局：</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Arena (竞技场)                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  Chunk (2MB)  │  Chunk (2MB)  │  Chunk (2MB)  │  ...        │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  Run (页组)   │  Run (页组)   │  Run (页组)   │  ...        │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  Bin (大小类) │  Bin (大小类) │  Bin (大小类) │  ...        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="1-3-核心组件"><a href="#1-3-核心组件" class="headerlink" title="1.3 核心组件"></a>1.3 核心组件</h3><h4 id="Arena-竞技场"><a href="#Arena-竞技场" class="headerlink" title="Arena (竞技场)"></a>Arena (竞技场)</h4><ul>
<li>每个 Arena 管理独立的内存池</li>
<li>默认情况下，每个 CPU 核心对应一个 Arena</li>
<li>减少线程间的锁竞争</li>
</ul>
<h4 id="Chunk-大块"><a href="#Chunk-大块" class="headerlink" title="Chunk (大块)"></a>Chunk (大块)</h4><ul>
<li>大小为 2MB 的内存块</li>
<li>是 Arena 分配的基本单位</li>
<li>支持不同的内存对齐要求</li>
</ul>
<h4 id="Run-页组"><a href="#Run-页组" class="headerlink" title="Run (页组)"></a>Run (页组)</h4><ul>
<li>由连续的页面组成</li>
<li>每个 Run 专门用于特定大小的分配</li>
<li>减少内存碎片</li>
</ul>
<h4 id="Bin-大小类"><a href="#Bin-大小类" class="headerlink" title="Bin (大小类)"></a>Bin (大小类)</h4><ul>
<li>将相似大小的分配请求归类</li>
<li>减少内存浪费</li>
<li>提高分配效率</li>
</ul>
<h2 id="2-分配策略"><a href="#2-分配策略" class="headerlink" title="2. 分配策略"></a>2. 分配策略</h2><h3 id="2-1-大小分类"><a href="#2-1-大小分类" class="headerlink" title="2.1 大小分类"></a>2.1 大小分类</h3><p>jemalloc 将分配请求按大小分为几类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 小对象分配 (≤ 8KB)</span></span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">8</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">    <span class="comment">// 使用 Bin 分配</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bin_alloc</span>(size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大对象分配 (8KB - 2MB)</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (size &lt;= <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">    <span class="comment">// 使用 Run 分配</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">run_alloc</span>(size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 超大对象分配 (&gt; 2MB)</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 直接使用 mmap</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">huge_alloc</span>(size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-线程本地缓存-TLS"><a href="#2-2-线程本地缓存-TLS" class="headerlink" title="2.2 线程本地缓存 (TLS)"></a>2.2 线程本地缓存 (TLS)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线程本地缓存结构</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">tcache_s</span> &#123;</span><br><span class="line">    <span class="type">tcache_bin_t</span> bins[TCACHE_NBINS];  <span class="comment">// 每个大小类的缓存</span></span><br><span class="line">    <span class="type">uint32_t</span> gc_incr;                 <span class="comment">// 垃圾回收增量</span></span><br><span class="line">    <span class="type">uint32_t</span> counts[TCACHE_NBINS];    <span class="comment">// 每个bin的计数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 快速分配路径</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">fast_alloc</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">tcache_bin_t</span>* bin = &amp;tcache-&gt;bins[<span class="built_in">size_to_bin</span>(size)];</span><br><span class="line">    <span class="keyword">if</span> (bin-&gt;ncached &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 从线程本地缓存分配</span></span><br><span class="line">        <span class="keyword">return</span> bin-&gt;avail[--bin-&gt;ncached];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 回退到 Arena 分配</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">arena_alloc</span>(size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-内存回收策略"><a href="#2-3-内存回收策略" class="headerlink" title="2.3 内存回收策略"></a>2.3 内存回收策略</h3><h4 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h4><ul>
<li>定期触发垃圾回收</li>
<li>将线程本地缓存的对象归还给 Arena</li>
<li>减少内存占用</li>
</ul>
<h4 id="内存合并"><a href="#内存合并" class="headerlink" title="内存合并"></a>内存合并</h4><ul>
<li>合并相邻的空闲块</li>
<li>减少内存碎片</li>
<li>提高内存利用率</li>
</ul>
<h2 id="3-多线程优化"><a href="#3-多线程优化" class="headerlink" title="3. 多线程优化"></a>3. 多线程优化</h2><h3 id="3-1-Arena-分配"><a href="#3-1-Arena-分配" class="headerlink" title="3.1 Arena 分配"></a>3.1 Arena 分配</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Arena 分配策略</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">arena_s</span> &#123;</span><br><span class="line">    <span class="type">malloc_mutex_t</span> lock;           <span class="comment">// Arena 锁</span></span><br><span class="line">    <span class="type">chunk_alloc_t</span>* chunk_alloc;    <span class="comment">// Chunk 分配器</span></span><br><span class="line">    <span class="type">chunk_dalloc_t</span>* chunk_dalloc;  <span class="comment">// Chunk 释放器</span></span><br><span class="line">    <span class="type">arena_bin_t</span> bins[NBINS];       <span class="comment">// 大小类数组</span></span><br><span class="line">    <span class="type">arena_runs_dirty_t</span> runs_dirty; <span class="comment">// 脏页管理</span></span><br><span class="line">    <span class="type">arena_large_t</span>* large;          <span class="comment">// 大对象管理</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程到 Arena 的映射</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">arena_t</span>* <span class="title">arena_choose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> arena_ind = <span class="built_in">atomic_fetch_add_u</span>(&amp;arenas_next_ind, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> arenas[arena_ind % narenas_auto];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-锁优化"><a href="#3-2-锁优化" class="headerlink" title="3.2 锁优化"></a>3.2 锁优化</h3><ul>
<li><strong>细粒度锁</strong>：每个 Arena 有独立的锁</li>
<li><strong>无锁分配</strong>：线程本地缓存无需加锁</li>
<li><strong>锁分片</strong>：减少锁竞争</li>
</ul>
<h2 id="4-使用场景"><a href="#4-使用场景" class="headerlink" title="4. 使用场景"></a>4. 使用场景</h2><h3 id="4-1-高性能服务器"><a href="#4-1-高性能服务器" class="headerlink" title="4.1 高性能服务器"></a>4.1 高性能服务器</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 C++ 项目中使用 jemalloc</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HighPerformanceServer</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 自定义内存分配器</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">JemallocAllocator</span> &#123;</span><br><span class="line">        <span class="function"><span class="type">void</span>* <span class="title">allocate</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">je_malloc</span>(size);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">deallocate</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">            <span class="built_in">je_free</span>(ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    std::vector&lt;<span class="type">int</span>, JemallocAllocator&gt; data_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process_request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使用 jemalloc 进行内存分配</span></span><br><span class="line">        <span class="keyword">auto</span> buffer = std::<span class="built_in">make_unique</span>&lt;<span class="type">char</span>[]&gt;(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// 处理请求...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-数据库系统"><a href="#4-2-数据库系统" class="headerlink" title="4.2 数据库系统"></a>4.2 数据库系统</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Redis 使用 jemalloc 的示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> USE_JEMALLOC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jemalloc/jemalloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> malloc je_malloc</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> free je_free</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> realloc je_realloc</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> calloc je_calloc</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存统计</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_memory_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> allocated, active, metadata;</span><br><span class="line">    <span class="type">size_t</span> len = <span class="built_in">sizeof</span>(<span class="type">size_t</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">mallctl</span>(<span class="string">&quot;stats.allocated&quot;</span>, &amp;allocated, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">mallctl</span>(<span class="string">&quot;stats.active&quot;</span>, &amp;active, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">mallctl</span>(<span class="string">&quot;stats.metadata&quot;</span>, &amp;metadata, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Allocated: %zu, Active: %zu, Metadata: %zu\n&quot;</span>, </span><br><span class="line">           allocated, active, metadata);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-游戏引擎"><a href="#4-3-游戏引擎" class="headerlink" title="4.3 游戏引擎"></a>4.3 游戏引擎</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏引擎中的内存管理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameEngine</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 对象池使用 jemalloc</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ObjectPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::vector&lt;T*, JemallocAllocator&gt; pool_;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">T* <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (pool_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">je_malloc</span>(<span class="built_in">sizeof</span>(T));</span><br><span class="line">            &#125;</span><br><span class="line">            T* obj = pool_.<span class="built_in">back</span>();</span><br><span class="line">            pool_.<span class="built_in">pop_back</span>();</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">(T* obj)</span> </span>&#123;</span><br><span class="line">            pool_.<span class="built_in">push_back</span>(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="5-配置和调优"><a href="#5-配置和调优" class="headerlink" title="5. 配置和调优"></a>5. 配置和调优</h2><h3 id="5-1-编译时配置"><a href="#5-1-编译时配置" class="headerlink" title="5.1 编译时配置"></a>5.1 编译时配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译 jemalloc</span></span><br><span class="line">./configure --prefix=/usr/local/jemalloc \</span><br><span class="line">           --enable-prof \</span><br><span class="line">           --enable-stats \</span><br><span class="line">           --enable-debug</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接 jemalloc</span></span><br><span class="line">g++ -o myapp myapp.cpp -ljemalloc</span><br></pre></td></tr></table></figure>

<h3 id="5-2-运行时配置"><a href="#5-2-运行时配置" class="headerlink" title="5.2 运行时配置"></a>5.2 运行时配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置 Arena 数量</span></span><br><span class="line"><span class="built_in">mallctl</span>(<span class="string">&quot;arenas.narenas&quot;</span>, &amp;narenas, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置线程本地缓存大小</span></span><br><span class="line"><span class="type">size_t</span> tcache_max = <span class="number">1024</span>;</span><br><span class="line"><span class="built_in">mallctl</span>(<span class="string">&quot;tcache.max&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tcache_max, <span class="built_in">sizeof</span>(tcache_max));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用内存统计</span></span><br><span class="line"><span class="type">bool</span> stats_active = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">mallctl</span>(<span class="string">&quot;stats.active&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;stats_active, <span class="built_in">sizeof</span>(stats_active));</span><br></pre></td></tr></table></figure>

<h3 id="5-3-环境变量"><a href="#5-3-环境变量" class="headerlink" title="5.3 环境变量"></a>5.3 环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 Arena 数量</span></span><br><span class="line"><span class="built_in">export</span> MALLOC_CONF=<span class="string">&quot;narenas:8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用内存统计</span></span><br><span class="line"><span class="built_in">export</span> MALLOC_CONF=<span class="string">&quot;stats:true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置线程本地缓存</span></span><br><span class="line"><span class="built_in">export</span> MALLOC_CONF=<span class="string">&quot;tcache_max:1024&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用内存分析</span></span><br><span class="line"><span class="built_in">export</span> MALLOC_CONF=<span class="string">&quot;prof:true,prof_prefix:/tmp/jeprof&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-常见问题和解决方案"><a href="#6-常见问题和解决方案" class="headerlink" title="6. 常见问题和解决方案"></a>6. 常见问题和解决方案</h2><h3 id="6-1-内存泄漏检测"><a href="#6-1-内存泄漏检测" class="headerlink" title="6.1 内存泄漏检测"></a>6.1 内存泄漏检测</h3><p>jemalloc 可能会暴露原本存在的内存问题：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题代码：内存泄漏</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryLeakExample</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span>* data_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MemoryLeakExample</span>() &#123;</span><br><span class="line">        data_ = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">1000</span>];  <span class="comment">// 分配内存</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">MemoryLeakExample</span>() &#123;</span><br><span class="line">        <span class="comment">// 忘记释放内存！</span></span><br><span class="line">        <span class="comment">// delete[] data_;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：使用智能指针</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SafeExample</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;<span class="type">int</span>[]&gt; data_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SafeExample</span>() : <span class="built_in">data_</span>(std::<span class="built_in">make_unique</span>&lt;<span class="type">int</span>[]&gt;(<span class="number">1000</span>)) &#123;&#125;</span><br><span class="line">    <span class="comment">// 析构函数自动释放内存</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-内存碎片问题"><a href="#6-2-内存碎片问题" class="headerlink" title="6.2 内存碎片问题"></a>6.2 内存碎片问题</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：频繁分配释放不同大小的内存</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fragment_memory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">void</span>*&gt; ptrs;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// 分配不同大小的内存</span></span><br><span class="line">        <span class="type">size_t</span> size = <span class="number">16</span> + (i % <span class="number">100</span>) * <span class="number">8</span>;</span><br><span class="line">        ptrs.<span class="built_in">push_back</span>(<span class="built_in">malloc</span>(size));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 随机释放一些内存</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500</span>; ++i) &#123;</span><br><span class="line">        <span class="type">int</span> idx = <span class="built_in">rand</span>() % ptrs.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">free</span>(ptrs[idx]);</span><br><span class="line">        ptrs.<span class="built_in">erase</span>(ptrs.<span class="built_in">begin</span>() + idx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放剩余内存</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">void</span>* ptr : ptrs) &#123;</span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：使用对象池</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectPool</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::stack&lt;T*&gt; pool_;</span><br><span class="line">    std::mutex mutex_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">T* <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (pool_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">T</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        T* obj = pool_.<span class="built_in">top</span>();</span><br><span class="line">        pool_.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">(T* obj)</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        pool_.<span class="built_in">push</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-性能调优"><a href="#6-3-性能调优" class="headerlink" title="6.3 性能调优"></a>6.3 性能调优</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监控内存使用</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryMonitor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">print_stats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> allocated, active, metadata;</span><br><span class="line">        <span class="type">size_t</span> len = <span class="built_in">sizeof</span>(<span class="type">size_t</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;stats.allocated&quot;</span>, &amp;allocated, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;stats.active&quot;</span>, &amp;active, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;stats.metadata&quot;</span>, &amp;metadata, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Memory Stats:\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Allocated: %zu bytes\n&quot;</span>, allocated);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Active: %zu bytes\n&quot;</span>, active);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Metadata: %zu bytes\n&quot;</span>, metadata);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  Fragmentation: %.2f%%\n&quot;</span>, </span><br><span class="line">               (<span class="type">double</span>)(active - allocated) / active * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">enable_profiling</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">bool</span> prof_active = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;prof.active&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;prof_active, <span class="built_in">sizeof</span>(prof_active));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="7-性能对比"><a href="#7-性能对比" class="headerlink" title="7. 性能对比"></a>7. 性能对比</h2><h3 id="7-1-与系统-malloc-对比"><a href="#7-1-与系统-malloc-对比" class="headerlink" title="7.1 与系统 malloc 对比"></a>7.1 与系统 malloc 对比</h3><table>
<thead>
<tr>
<th>指标</th>
<th>系统 malloc</th>
<th>jemalloc</th>
<th>改进</th>
</tr>
</thead>
<tbody><tr>
<td>分配速度</td>
<td>基准</td>
<td>+15-25%</td>
<td>显著提升</td>
</tr>
<tr>
<td>内存碎片</td>
<td>基准</td>
<td>-50-70%</td>
<td>大幅减少</td>
</tr>
<tr>
<td>多线程性能</td>
<td>基准</td>
<td>+100-200%</td>
<td>显著提升</td>
</tr>
<tr>
<td>内存占用</td>
<td>基准</td>
<td>-10-20%</td>
<td>适度减少</td>
</tr>
</tbody></table>
<h3 id="7-2-实际测试数据"><a href="#7-2-实际测试数据" class="headerlink" title="7.2 实际测试数据"></a>7.2 实际测试数据</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能测试代码</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">benchmark_allocator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> num_allocations = <span class="number">1000000</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> num_threads = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    </span><br><span class="line">    std::vector&lt;std::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> t = <span class="number">0</span>; t &lt; num_threads; ++t) &#123;</span><br><span class="line">        threads.<span class="built_in">emplace_back</span>([num_allocations]() &#123;</span><br><span class="line">            std::vector&lt;<span class="type">void</span>*&gt; ptrs;</span><br><span class="line">            ptrs.<span class="built_in">reserve</span>(num_allocations);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_allocations; ++i) &#123;</span><br><span class="line">                <span class="type">size_t</span> size = <span class="number">16</span> + (i % <span class="number">1000</span>) * <span class="number">8</span>;</span><br><span class="line">                ptrs.<span class="built_in">push_back</span>(<span class="built_in">malloc</span>(size));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">void</span>* ptr : ptrs) &#123;</span><br><span class="line">                <span class="built_in">free</span>(ptr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; thread : threads) &#123;</span><br><span class="line">        thread.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> duration = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(end - start);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Allocation benchmark completed in %lld ms\n&quot;</span>, duration.<span class="built_in">count</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-最佳实践"><a href="#8-最佳实践" class="headerlink" title="8. 最佳实践"></a>8. 最佳实践</h2><h3 id="8-1-内存分配模式"><a href="#8-1-内存分配模式" class="headerlink" title="8.1 内存分配模式"></a>8.1 内存分配模式</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的实践：批量分配</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BatchAllocator</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;<span class="type">void</span>*&gt; batch_;</span><br><span class="line">    <span class="type">size_t</span> batch_size_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BatchAllocator</span>(<span class="type">size_t</span> batch_size = <span class="number">1000</span>) : <span class="built_in">batch_size_</span>(batch_size) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span>* <span class="title">allocate</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (batch_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="comment">// 批量预分配</span></span><br><span class="line">            batch_.<span class="built_in">reserve</span>(batch_size_);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; batch_size_; ++i) &#123;</span><br><span class="line">                batch_.<span class="built_in">push_back</span>(<span class="built_in">malloc</span>(size));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">void</span>* ptr = batch_.<span class="built_in">back</span>();</span><br><span class="line">        batch_.<span class="built_in">pop_back</span>();</span><br><span class="line">        <span class="keyword">return</span> ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deallocate</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">        batch_.<span class="built_in">push_back</span>(ptr);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (batch_.<span class="built_in">size</span>() &gt; batch_size_ * <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 清理多余的缓存</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = batch_size_; i &lt; batch_.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">                <span class="built_in">free</span>(batch_[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            batch_.<span class="built_in">resize</span>(batch_size_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-内存对齐"><a href="#8-2-内存对齐" class="headerlink" title="8.2 内存对齐"></a>8.2 内存对齐</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存对齐分配</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlignedAllocator</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">allocate_aligned</span><span class="params">(<span class="type">size_t</span> size, <span class="type">size_t</span> alignment)</span> </span>&#123;</span><br><span class="line">        <span class="type">void</span>* ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="type">int</span> result = <span class="built_in">posix_memalign</span>(&amp;ptr, alignment, size);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">bad_alloc</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">deallocate_aligned</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlignedBuffer</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">void</span>* data_;</span><br><span class="line">    <span class="type">size_t</span> size_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">AlignedBuffer</span>(<span class="type">size_t</span> size, <span class="type">size_t</span> alignment = <span class="number">64</span>) </span><br><span class="line">        : <span class="built_in">size_</span>(size) &#123;</span><br><span class="line">        data_ = AlignedAllocator::<span class="built_in">allocate_aligned</span>(size, alignment);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">AlignedBuffer</span>() &#123;</span><br><span class="line">        AlignedAllocator::<span class="built_in">deallocate_aligned</span>(data_);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span>* <span class="title">data</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> data_; &#125;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> size_; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-内存池设计"><a href="#8-3-内存池设计" class="headerlink" title="8.3 内存池设计"></a>8.3 内存池设计</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 固定大小内存池</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="type">size_t</span> BlockSize&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FixedSizePool</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Block</span> &#123;</span><br><span class="line">        Block* next;</span><br><span class="line">        <span class="type">char</span> data[BlockSize];</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Block* free_list_;</span><br><span class="line">    std::vector&lt;Block*&gt; allocated_blocks_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">FixedSizePool</span>() : <span class="built_in">free_list_</span>(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span>* <span class="title">allocate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!free_list_) &#123;</span><br><span class="line">            <span class="built_in">allocate_new_block</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Block* block = free_list_;</span><br><span class="line">        free_list_ = block-&gt;next;</span><br><span class="line">        allocated_blocks_.<span class="built_in">push_back</span>(block);</span><br><span class="line">        <span class="keyword">return</span> block-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deallocate</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">        Block* block = <span class="built_in">reinterpret_cast</span>&lt;Block*&gt;(</span><br><span class="line">            <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(ptr) - <span class="built_in">offsetof</span>(Block, data));</span><br><span class="line">        </span><br><span class="line">        block-&gt;next = free_list_;</span><br><span class="line">        free_list_ = block;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从已分配列表中移除</span></span><br><span class="line">        <span class="keyword">auto</span> it = std::<span class="built_in">find</span>(allocated_blocks_.<span class="built_in">begin</span>(), </span><br><span class="line">                           allocated_blocks_.<span class="built_in">end</span>(), block);</span><br><span class="line">        <span class="keyword">if</span> (it != allocated_blocks_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            allocated_blocks_.<span class="built_in">erase</span>(it);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">allocate_new_block</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">size_t</span> blocks_per_chunk = <span class="number">1024</span>;</span><br><span class="line">        Block* chunk = <span class="built_in">reinterpret_cast</span>&lt;Block*&gt;(</span><br><span class="line">            <span class="built_in">malloc</span>(blocks_per_chunk * <span class="built_in">sizeof</span>(Block)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构建空闲链表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; blocks_per_chunk - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            chunk[i].next = &amp;chunk[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        chunk[blocks_per_chunk - <span class="number">1</span>].next = <span class="literal">nullptr</span>;</span><br><span class="line">        </span><br><span class="line">        free_list_ = &amp;chunk[<span class="number">1</span>];</span><br><span class="line">        allocated_blocks_.<span class="built_in">push_back</span>(&amp;chunk[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="9-监控和调试"><a href="#9-监控和调试" class="headerlink" title="9. 监控和调试"></a>9. 监控和调试</h2><h3 id="9-1-内存使用监控"><a href="#9-1-内存使用监控" class="headerlink" title="9.1 内存使用监控"></a>9.1 内存使用监控</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存使用监控器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryMonitor</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::chrono::steady_clock::time_point last_check_;</span><br><span class="line">    <span class="type">size_t</span> last_allocated_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MemoryMonitor</span>() : <span class="built_in">last_allocated_</span>(<span class="number">0</span>) &#123;</span><br><span class="line">        last_check_ = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">check_memory_usage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> allocated, active, metadata;</span><br><span class="line">        <span class="type">size_t</span> len = <span class="built_in">sizeof</span>(<span class="type">size_t</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;stats.allocated&quot;</span>, &amp;allocated, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;stats.active&quot;</span>, &amp;active, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">mallctl</span>(<span class="string">&quot;stats.metadata&quot;</span>, &amp;metadata, &amp;len, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">auto</span> now = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br><span class="line">        <span class="keyword">auto</span> duration = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(</span><br><span class="line">            now - last_check_).<span class="built_in">count</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">size_t</span> diff = allocated - last_allocated_;</span><br><span class="line">            <span class="type">double</span> rate = <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(diff) / duration;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Memory usage: %zu bytes (%.2f bytes/sec)\n&quot;</span>, </span><br><span class="line">                   allocated, rate);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        last_allocated_ = allocated;</span><br><span class="line">        last_check_ = now;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-内存泄漏检测"><a href="#9-2-内存泄漏检测" class="headerlink" title="9.2 内存泄漏检测"></a>9.2 内存泄漏检测</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存泄漏检测器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LeakDetector</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unordered_set&lt;<span class="type">void</span>*&gt; allocated_ptrs_;</span><br><span class="line">    std::mutex mutex_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span>* <span class="title">track_allocation</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        allocated_ptrs_.<span class="built_in">insert</span>(ptr);</span><br><span class="line">        <span class="keyword">return</span> ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">track_deallocation</span><span class="params">(<span class="type">void</span>* ptr)</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        allocated_ptrs_.<span class="built_in">erase</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">report_leaks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (!allocated_ptrs_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Memory leak detected: %zu objects not freed\n&quot;</span>, </span><br><span class="line">                   allocated_ptrs_.<span class="built_in">size</span>());</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">void</span>* ptr : allocated_ptrs_) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;  Leaked pointer: %p\n&quot;</span>, ptr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局泄漏检测器</span></span><br><span class="line"><span class="type">static</span> LeakDetector g_leak_detector;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重载 new/delete 进行跟踪</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span>* ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">    g_leak_detector.<span class="built_in">track_allocation</span>(ptr);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="keyword">operator</span> <span class="title">delete</span><span class="params">(<span class="type">void</span>* ptr)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    g_leak_detector.<span class="built_in">track_deallocation</span>(ptr);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><p>jemalloc 是一个高性能的内存分配器，特别适合多线程环境和高性能应用。它的主要优势包括：</p>
<ol>
<li><strong>减少内存碎片</strong>：通过精心设计的内存布局和分配策略</li>
<li><strong>提高多线程性能</strong>：减少线程间的锁竞争</li>
<li><strong>可扩展性</strong>：支持大内存分配和多种分配模式</li>
<li><strong>可观测性</strong>：提供详细的内存使用统计信息</li>
</ol>
<h3 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h3><ol>
<li><strong>选择合适的场景</strong>：多线程、高并发应用</li>
<li><strong>正确配置</strong>：根据应用特点调整参数</li>
<li><strong>监控内存使用</strong>：及时发现和解决问题</li>
<li><strong>遵循最佳实践</strong>：避免常见的内存管理错误</li>
</ol>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><strong>可能暴露内存问题</strong>：jemalloc 的严格内存管理可能暴露原本存在的内存泄漏或越界访问</li>
<li><strong>学习成本</strong>：需要了解其工作原理和配置选项</li>
<li><strong>调试复杂性</strong>：内存问题的调试可能更加复杂</li>
</ol>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc">jemalloc 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bsdcan.org/2006/papers/jemalloc.pdf">jemalloc 论文：A Scalable Concurrent malloc(3) Implementation for FreeBSD</a></li>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/memory-optimization">Redis 内存优化实践</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.fb.com/2011/01/03/core-data/scalable-memory-allocation-using-jemalloc/">Facebook 内存分配器对比</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/29216091">知乎：jemalloc 内存分配器详解</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangyifei216/article/details/52247365">CSDN：jemalloc 源码分析</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2019/03/07/jemalloc-in-meituan.html">美团技术团队：jemalloc 在美团的实践</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1004367">腾讯技术工程：内存分配器对比分析</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/07/10/Programming/CPP/jemalloc/" data-id="cmdpf31ay0034q0on0c9v4304" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/07/10/Programming/CPP/modern%20cpu/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2025/07/07/Programming/CPP/gRPC%20vs%20restful/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Test/">Test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Attention/" rel="tag">Attention</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Communication/" rel="tag">Communication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compiler/" rel="tag">Compiler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Computational-Graph/" rel="tag">Computational Graph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DeepSeek/" rel="tag">DeepSeek</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed/" rel="tag">Distributed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LLM/" rel="tag">LLM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MoE/" rel="tag">MoE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Optimization/" rel="tag">Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/" rel="tag">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SGLang/" rel="tag">SGLang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/" rel="tag">System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blues/" rel="tag">blues</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/career/" rel="tag">career</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/charts/" rel="tag">charts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/consensus/" rel="tag">consensus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/data-parallelism/" rel="tag">data-parallelism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed-systems/" rel="tag">distributed-systems</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experience/" rel="tag">experience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/expert-parallelism/" rel="tag">expert-parallelism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/guitar/" rel="tag">guitar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/harmony/" rel="tag">harmony</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/licks/" rel="tag">licks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/llm/" rel="tag">llm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mermaid/" rel="tag">mermaid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raft/" rel="tag">raft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rhythm/" rel="tag">rhythm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/Attention/" style="font-size: 10px;">Attention</a> <a href="/tags/Communication/" style="font-size: 10px;">Communication</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Computational-Graph/" style="font-size: 10px;">Computational Graph</a> <a href="/tags/DeepSeek/" style="font-size: 10px;">DeepSeek</a> <a href="/tags/Distributed/" style="font-size: 10px;">Distributed</a> <a href="/tags/LLM/" style="font-size: 10px;">LLM</a> <a href="/tags/MoE/" style="font-size: 10px;">MoE</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/SGLang/" style="font-size: 10px;">SGLang</a> <a href="/tags/System/" style="font-size: 15px;">System</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/blues/" style="font-size: 20px;">blues</a> <a href="/tags/career/" style="font-size: 10px;">career</a> <a href="/tags/charts/" style="font-size: 10px;">charts</a> <a href="/tags/consensus/" style="font-size: 10px;">consensus</a> <a href="/tags/data-parallelism/" style="font-size: 10px;">data-parallelism</a> <a href="/tags/distributed-systems/" style="font-size: 20px;">distributed-systems</a> <a href="/tags/experience/" style="font-size: 10px;">experience</a> <a href="/tags/expert-parallelism/" style="font-size: 10px;">expert-parallelism</a> <a href="/tags/guitar/" style="font-size: 20px;">guitar</a> <a href="/tags/harmony/" style="font-size: 10px;">harmony</a> <a href="/tags/licks/" style="font-size: 10px;">licks</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/llm/" style="font-size: 15px;">llm</a> <a href="/tags/mermaid/" style="font-size: 10px;">mermaid</a> <a href="/tags/raft/" style="font-size: 10px;">raft</a> <a href="/tags/rhythm/" style="font-size: 10px;">rhythm</a> <a href="/tags/test/" style="font-size: 10px;">test</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">July 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">January 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/07/30/System/%E5%B9%B6%E8%A1%8C%E7%AD%96%E7%95%A5/%E5%BA%8F%E5%88%97%E5%B9%B6%E8%A1%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/28/PD%E5%88%86%E7%A6%BB%E6%9E%B6%E6%9E%84KVCache%E8%B7%A8%E8%8A%82%E7%82%B9%E4%BC%A0%E8%BE%93%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91%EF%BC%8C%E4%BC%98%E5%8C%96KVCache%E4%BC%A0%E8%BE%93%E6%95%88%E7%8E%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/28/System/%E5%B9%B6%E8%A1%8C%E7%AD%96%E7%95%A5/EP/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/28/System/%E5%B9%B6%E8%A1%8C%E7%AD%96%E7%95%A5/%E9%9B%86%E5%90%88%E9%80%9A%E4%BF%A1%E5%9F%BA%E7%A1%80/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/07/28/System/DeepSeek/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>






<!-- Mermaid Support -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    themeVariables: {
      primaryColor: '#0f4c75',
      primaryTextColor: '#fff',
      primaryBorderColor: '#0f4c75',
      lineColor: '#0f4c75',
      secondaryColor: '#006ba6',
      tertiaryColor: '#fff'
    }
  });
</script>
  </div>
</body>
</html>